<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn - PageX</title>
</head>
<body>
    <button id="authButton">Authenticate</button>

    <script>
        // Helper function to convert base64 to Uint8Array
        function base64ToUint8Array(base64) {
            return Uint8Array.fromBase64(base64, {alphabet: 'base64url'});
        }

        // Helper function to convert Uint8Array to base64
        function uint8ArrayToBase64(uint8Array) {
            return uint8Array.toBase64({alphabet: 'base64url'});
        }

        // Helper function to convert string to Uint8Array
        function stringToUint8Array(str) {
            return new TextEncoder().encode(str);
        }

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const challenge = urlParams.get('challenge');
        const type = urlParams.get('type');
        const userId = urlParams.get('user_id');
        const callback = urlParams.get('callback');
        const statexx = urlParams.get('state') || ''

        // Validate required parameters
        if (!challenge || !type || !callback) {
            alert('Missing required parameters');
            throw new Error('Missing required parameters');
        }

        if (type === 'create' && !userId) {
            alert('User ID required for create operation');
            throw new Error('User ID required for create operation');
        }

        // Convert challenge from base64 to Uint8Array
        const challengeBytes = base64ToUint8Array(challenge);

        document.getElementById('authButton').addEventListener('click', async function() {
            try {
                if (type === 'create') {
                    // Create new credentials
                    const publicKeyCredentialCreationOptions = {
                        challenge: challengeBytes,
                        rp: {
                            name: 'PageX',
                            id: 'adityamitra5102.github.io'
                        },
                        user: {
                            id: stringToUint8Array(userId),
                            name: userId,
                            displayName: userId
                        },
                         pubKeyCredParams: [
                            {
                                alg: -7, // ES256
                                type: 'public-key'
                            },
                            {
                                alg: -257, // RS256
                                type: 'public-key'
                            }
                        ],
                        timeout: 60000,
                        attestation: 'none'
                    };

                    const credential = await navigator.credentials.create({
                        publicKey: publicKeyCredentialCreationOptions
                    });

                    console.log(credential);
                    const response = credential.response;
                    console.log(response);
                    const attestationObject = uint8ArrayToBase64(new Uint8Array(response.attestationObject));
                    const clientDataJSON = uint8ArrayToBase64(new Uint8Array(response.clientDataJSON));
                    const authenticatorId= uint8ArrayToBase64(new Uint8Array(credential.raw_id));
                    

                    // Redirect to callback with encoded parameters
                    const callbackUrl = new URL(callback);
                    callbackUrl.searchParams.set('attestationObject', attestationObject);
                    callbackUrl.searchParams.set('clientDataJSON', clientDataJSON);
                    callbackUrl.searchParams.set('authenticatorId', authenticatorId);
                    callbackUrl.searchParams.set('state', statexx);
                    
                    window.location.href = callbackUrl.toString();

                } else if (type === 'get') {
                    // Get existing credentials
                    const publicKeyCredentialRequestOptions = {
                        challenge: challengeBytes,
                        rpId: 'adityamitra5102.github.io',
                        timeout: 60000,
                        userVerification: 'preferred'
                    };

                    const credential = await navigator.credentials.get({
                        publicKey: publicKeyCredentialRequestOptions
                    });

                    console.log(credential);
                    const response = credential.response;
                    console.log(response);
                    const authenticatorData = uint8ArrayToBase64(new Uint8Array(response.authenticatorData));
                    const clientDataJSON = uint8ArrayToBase64(new Uint8Array(response.clientDataJSON));
                    const signature = uint8ArrayToBase64(new Uint8Array(response.signature));
                    const authenticatorId= uint8ArrayToBase64(new Uint8Array(credential.rawId));

                    // Redirect to callback with encoded parameters
                    const callbackUrl = new URL(callback);
                    callbackUrl.searchParams.set('authenticatorData', authenticatorData);
                    callbackUrl.searchParams.set('clientDataJSON', clientDataJSON);
                    callbackUrl.searchParams.set('signature', signature);
                    callbackUrl.searchParams.set('authenticatorId', authenticatorId);
                    callbackUrl.searchParams.set('state', statexx);
                    
                    window.location.href = callbackUrl.toString();

                } else {
                    alert('Invalid type parameter. Must be "create" or "get"');
                }

            } catch (error) {
                console.error('WebAuthn error:', error);
                alert('Authentication failed: ' + error.message);
            }
        });
    </script>
</body>
</html>
